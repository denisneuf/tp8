{extend name="admin/layout" /}

{block name="content"}

    {if isset($success)}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <strong>Éxito:</strong> {$success}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
    {/if}

    {if isset($error)}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <strong>Error:</strong> {$error}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
    {/if}

<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold">
            <i class="fas fa-edit me-2"></i>Listado de Menús
        </h6>
        <a href="{:url('menu_create')}" class="btn btn-secondary btn-sm">
            <i class="bi bi-plus-square me-2"></i>Crear Menú
        </a>
    </div>

    <div class="card-body">
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Título</th>
                    <th>URL</th>
                    <th>Orden</th>
                    <th>Columnas</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {foreach $menus as $menu}
                <tr class="{if $menu.delete_time}table-secondary{/if}">
                    <td>{$menu.id}</td>
                    <td>{$menu.title|raw}</td>
                    <td>{$menu.url}</td>
                    <td>{$menu.order}</td>
                    <td>
                        {if $menu.columns && count($menu.columns) > 0}
                        <div class="accordion" id="accordionMenu-{$menu.id}">
                            {foreach $menu.columns as $index => $column}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading-{$menu.id}-{$index}">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#collapse-{$menu.id}-{$index}" 
                                            aria-expanded="false" 
                                            aria-controls="collapse-{$menu.id}-{$index}">
                                        <strong>{$column.title}</strong>
                                        <span class="badge bg-primary ms-2">{$column.links|count} enlaces</span>
                                    </button>
                                </h2>
                                <div id="collapse-{$menu.id}-{$index}" 
                                     class="accordion-collapse collapse" 
                                     aria-labelledby="heading-{$menu.id}-{$index}" 
                                     data-bs-parent="#accordionMenu-{$menu.id}">
                                    <div class="accordion-body p-2">
                                        {if $column.links && count($column.links) > 0}
                                        <ul class="list-group list-group-flush">
                                            {foreach $column.links as $link}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="me-2"><a href="{$link.url}" target="_blank"> {$link.title}</a></span>
                                                    <!--<small class="text-muted">{$link.url}</small>-->
                                                </div>
                                                <span class="badge bg-light text-dark">Orden: {$link.order}</span>
                                            </li>
                                            {/foreach}
                                        </ul>
                                        {else}
                                        <p class="text-muted mb-0">No hay enlaces en esta columna</p>
                                        {/if}
                                    </div>
                                </div>
                            </div>
                            {/foreach}
                        </div>
                        {else}
                        <span class="text-muted">Sin columnas</span>
                        {/if}
                    </td>
                    <td>
                        {if !$menu.delete_time}
                            <span class="badge bg-success">Activo</span>
                        {else}
                            <span class="badge bg-danger">Eliminado</span>
                        {/if}
                    </td>
                    <td>
                        <div class="btn-group-vertical btn-group-sm">
                            {if !$menu.delete_time}
                                <a href="{:url('menu_edit', ['id' => $menu.id])}" 
                                   class="btn btn-primary rounded-pill mb-1">
                                    <i class="bi bi-pencil me-1"></i>Editar
                                </a>
                                <button type="button" class="btn btn-danger rounded-pill mb-1" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#actionModal" 
                                        data-id="{$menu.id}" 
                                        data-action="delete">
                                    <i class="bi bi-trash me-1"></i>Eliminar
                                </button>
                            {else}
                                <button type="button" class="btn btn-warning rounded-pill mb-1" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#actionModal" 
                                        data-id="{$menu.id}" 
                                        data-action="restore">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>Restaurar
                                </button>
                                <button type="button" class="btn btn-dark rounded-pill" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#actionModal" 
                                        data-id="{$menu.id}" 
                                        data-action="forceDelete">
                                    <i class="bi bi-trash-fill me-1"></i>Eliminar
                                </button>
                            {/if}
                        </div>
                    </td>
                </tr>
                {/foreach}
            </tbody>
        </table>
    </div>
</div>

<div class="pagination pagination-primary">
{$menus|raw}
</div>

<!-- Modal genérico -->
<div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" id="actionForm">
      <input type="hidden" name="__token__" value="{:token()}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="actionModalLabel">Confirmar acción</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="actionModalBody">
          ¿Estás seguro de que deseas realizar esta acción?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn" id="actionModalSubmit">Aceptar</button>
        </div>
      </div>
    </form>
  </div>
</div>

{/block}

{block name="scripts"}
    <!-- Script para el modal -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const actionModal = document.getElementById('actionModal');
        const form = actionModal.querySelector('#actionForm');
        const title = actionModal.querySelector('#actionModalLabel');
        const body = actionModal.querySelector('#actionModalBody');
        const submitBtn = actionModal.querySelector('#actionModalSubmit');

        actionModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const menuId = button.getAttribute('data-id');
            const actionType = button.getAttribute('data-action');

            if (actionType === 'delete') {
                title.textContent = 'Confirmar eliminación';
                body.textContent = '¿Estás seguro de que deseas eliminar este menú? Se moverá a la papelera.';
                submitBtn.textContent = 'Eliminar';
                submitBtn.className = 'btn btn-danger';
                form.setAttribute('action', `{:url('menu_delete')}?id=${menuId}`);
            } else if (actionType === 'restore') {
                title.textContent = 'Confirmar restauración';
                body.textContent = '¿Estás seguro de que deseas restaurar este menú?';
                submitBtn.textContent = 'Restaurar';
                submitBtn.className = 'btn btn-warning';
                form.setAttribute('action', `{:url('menu_restore')}?id=${menuId}`);
            } else if (actionType === 'forceDelete') {
                title.textContent = 'Confirmar eliminación permanente';
                body.textContent = '⚠️ ADVERTENCIA: Esta acción NO se puede deshacer. ¿Estás seguro de que deseas eliminar este menú permanentemente?';
                submitBtn.textContent = 'Eliminar';
                submitBtn.className = 'btn btn-dark';
                form.setAttribute('action', `{:url('menu_force_delete')}?id=${menuId}`);
            }
        });
    });
    </script>

{/block}