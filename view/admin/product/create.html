{extend name="admin/layout" /}

{block name="content"}

    <!-- Alertas de notificaci√≥n -->
    {if isset($error)}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <strong>Error:</strong> {$error}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {/if}

    {if isset($success)}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle mr-2"></i>
            <strong>√âxito:</strong> {$success}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {/if}

    <!-- Tarjeta principal del formulario -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold">
                <i class="fas fa-cube me-2"></i>Crear Nuevo Producto
            </h6>
            <a href="{:url('product_index')}" class="btn btn-secondary btn-sm">
                <i class="bi bi-arrow-left me-2"></i>Volver al Listado
            </a>
        </div>
        <div class="card-body">
            <form action="{:url('product_save')}" method="post" novalidate enctype="multipart/form-data">
                {:token_field()}
                
                <!-- Tabs de navegaci√≥n -->
                <ul class="nav nav-tabs mb-4" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#general" role="tab">
                            <i class="bi bi-info-circle me-1"></i>Informaci√≥n General
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#attributes" role="tab">
                            <i class="bi bi-tags me-1"></i>Atributos Especiales
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#seo" role="tab">
                            <i class="bi bi-search me-1"></i>SEO y Meta Tags
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Tab: Informaci√≥n General -->
                    <div class="tab-pane fade show active" id="general" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3"><i class="bi bi-info-circle me-2"></i>Informaci√≥n B√°sica</h5>
                                
                                <div class="mb-3">
                                    <label for="name" class="form-label">Nombre del Producto <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control {if isset($error_field) && $error_field == 'name'}is-invalid{/if}" 
                                           name="name" id="name" required 
                                           maxlength="255" value="{if isset($old_data.name)}{$old_data.name}{/if}"
                                           placeholder="Nombre completo del producto">
                                    {if isset($error_field) && $error_field == 'name'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">M√°ximo 255 caracteres. Este campo es obligatorio.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="slug" class="form-label">Slug <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control {if isset($error_field) && $error_field == 'slug'}is-invalid{/if}" 
                                           name="slug" id="slug" required 
                                           maxlength="255" value="{if isset($old_data.slug)}{$old_data.slug}{/if}"
                                           placeholder="nombre-del-producto">
                                    {if isset($error_field) && $error_field == 'slug'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">M√°ximo 255 caracteres. URL amigable del producto.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="asin" class="form-label">ASIN <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control {if isset($error_field) && $error_field == 'asin'}is-invalid{/if}" 
                                           name="asin" id="asin" required 
                                           maxlength="10" value="{if isset($old_data.asin)}{$old_data.asin}{/if}"
                                           placeholder="B0XXXXXXXXX">
                                    {if isset($error_field) && $error_field == 'asin'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">C√≥digo √∫nico de identificaci√≥n de Amazon (m√°x. 10 caracteres).</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="sku" class="form-label">SKU <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control {if isset($error_field) && $error_field == 'sku'}is-invalid{/if}" 
                                           name="sku" id="sku" required 
                                           maxlength="40" value="{if isset($old_data.sku)}{$old_data.sku}{/if}"
                                           placeholder="SKU-001">
                                    {if isset($error_field) && $error_field == 'sku'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">C√≥digo √∫nico de stock del producto (m√°x. 40 caracteres).</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3"><i class="bi bi-building me-2"></i>Fabricante y Precio</h5>
                                
                                <div class="mb-3">
                                    <label for="manufacturer" class="form-label">Fabricante <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control {if isset($error_field) && $error_field == 'manufacturer'}is-invalid{/if}" 
                                           name="manufacturer" id="manufacturer" required 
                                           maxlength="15" value="{if isset($old_data.manufacturer)}{$old_data.manufacturer}{/if}"
                                           placeholder="Nombre del fabricante">
                                    {if isset($error_field) && $error_field == 'manufacturer'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">M√°ximo 15 caracteres.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="productcode" class="form-label">C√≥digo de Producto</label>
                                    <input type="text" class="form-control {if isset($error_field) && $error_field == 'productcode'}is-invalid{/if}" 
                                           name="productcode" id="productcode" 
                                           maxlength="13" value="{if isset($old_data.productcode)}{$old_data.productcode}{/if}"
                                           placeholder="C√≥digo interno">
                                    {if isset($error_field) && $error_field == 'productcode'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">M√°ximo 13 caracteres.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="price" class="form-label">Precio ($)</label>
                                    <input type="number" step="0.01" min="0" 
                                           class="form-control {if isset($error_field) && $error_field == 'price'}is-invalid{/if}" 
                                           name="price" id="price" 
                                           value="{if isset($old_data.price)}{$old_data.price}{/if}"
                                           placeholder="0.00">
                                    {if isset($error_field) && $error_field == 'price'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="amazonlink" class="form-label">Enlace de Amazon</label>
                                    <input type="url" class="form-control {if isset($error_field) && $error_field == 'amazonlink'}is-invalid{/if}" 
                                           name="amazonlink" id="amazonlink" 
                                           maxlength="255" value="{if isset($old_data.amazonlink)}{$old_data.amazonlink}{/if}"
                                           placeholder="https://www.amazon.com/dp/ASIN">
                                    {if isset($error_field) && $error_field == 'amazonlink'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3"><i class="bi bi-image me-2"></i>Imagen del Producto</h5>
                                
                                <div class="mb-3">
                                    <label for="pic" class="form-label">Imagen Principal</label>
                                    <input type="file" class="form-control {if isset($error_field) && $error_field == 'pic'}is-invalid{/if}" 
                                           name="pic" id="pic" accept="image/*">
                                    {if isset($error_field) && $error_field == 'pic'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">
                                        üìè <strong>Requisitos:</strong> Imagen cuadrada (mismo ancho y alto)<br>
                                        üìê <strong>Tama√±o m√≠nimo:</strong> 1500√ó1500 p√≠xeles<br>
                                        üñºÔ∏è <strong>Formatos:</strong> JPG, PNG, WebP
                                    </div>
                                    <!-- Contenedor para previsualizaci√≥n -->
                                    <div id="picPreview" class="mt-2"></div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3"><i class="bi bi-diagram-3 me-2"></i>Categorizaci√≥n</h5>
                                
                                <div class="mb-3">
                                    <label for="brand_id" class="form-label">Marca <span class="text-danger">*</span></label>
                                    <select class="form-control {if isset($error_field) && $error_field == 'brand_id'}is-invalid{/if}" 
                                            name="brand_id" id="brand_id" required>
                                        <option value="">Selecciona una marca</option>
                                        {volist name="brands" id="brand"}
                                            <option value="{$brand.id}" {if isset($old_data.brand_id) && $old_data.brand_id == $brand.id}selected{/if}>
                                                {$brand.brand_en}
                                            </option>
                                        {/volist}
                                    </select>
                                    {if isset($error_field) && $error_field == 'brand_id'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="category_id" class="form-label">Categor√≠a <span class="text-danger">*</span></label>
                                    <select class="form-control {if isset($error_field) && $error_field == 'category_id'}is-invalid{/if}" 
                                            name="category_id" id="category_id" required>
                                        <option value="">Selecciona una categor√≠a</option>
                                        {volist name="categories" id="category"}
                                            <option value="{$category.id}" {if isset($old_data.category_id) && $old_data.category_id == $category.id}selected{/if}>
                                                {$category.txt_short}
                                            </option>
                                        {/volist}
                                    </select>
                                    {if isset($error_field) && $error_field == 'category_id'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product_type_id" class="form-label">Tipo de Producto <span class="text-danger">*</span></label>
                                    <select class="form-control {if isset($error_field) && $error_field == 'product_type_id'}is-invalid{/if}" 
                                            name="product_type_id" id="product_type_id" required>
                                        <option value="">Selecciona un tipo</option>
                                        {volist name="productTypes" id="type"}
                                            <option value="{$type.id}" {if isset($old_data.product_type_id) && $old_data.product_type_id == $type.id}selected{/if}>
                                                {$type.txt_short}
                                            </option>
                                        {/volist}
                                    </select>
                                    {if isset($error_field) && $error_field == 'product_type_id'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <h5 class="text-primary mb-3"><i class="bi bi-text-paragraph me-2"></i>Descripci√≥n y Stock</h5>
                                
                                <div class="mb-3">
                                    <label for="description" class="form-label">Descripci√≥n del Producto</label>
                                    <textarea class="form-control {if isset($error_field) && $error_field == 'description'}is-invalid{/if}" 
                                              name="description" id="description" 
                                              rows="4" maxlength="65535">{if isset($old_data.description)}{$old_data.description}{/if}</textarea>
                                    {if isset($error_field) && $error_field == 'description'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">M√°ximo 65,535 caracteres.</div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="stock" class="form-label">Stock</label>
                                            <input type="number" min="0" 
                                                   class="form-control {if isset($error_field) && $error_field == 'stock'}is-invalid{/if}" 
                                                   name="stock" id="stock" 
                                                   value="{if isset($old_data.stock)}{$old_data.stock}{else}0{/if}">
                                            {if isset($error_field) && $error_field == 'stock'}
                                                <div class="invalid-feedback">{$error}</div>
                                            {/if}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="like" class="form-label">Likes</label>
                                            <input type="number" min="0" 
                                                   class="form-control {if isset($error_field) && $error_field == 'like'}is-invalid{/if}" 
                                                   name="like" id="like" 
                                                   value="{if isset($old_data.like)}{$old_data.like}{else}0{/if}">
                                            {if isset($error_field) && $error_field == 'like'}
                                                <div class="invalid-feedback">{$error}</div>
                                            {/if}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Estado</label>
                                            <div class="form-check">
                                                <input type="hidden" name="visible" value="0">
                                                <input class="form-check-input {if isset($error_field) && $error_field == 'visible'}is-invalid{/if}" 
                                                       type="checkbox" id="visible" name="visible" value="1"
                                                       {if !isset($old_data.visible) || (isset($old_data.visible) && $old_data.visible == 1)}checked{/if}>
                                                <label class="form-check-label" for="visible">Visible</label>
                                            </div>
                                            <div class="form-check mt-2">
                                                <input type="hidden" name="available" value="0">
                                                <input class="form-check-input {if isset($error_field) && $error_field == 'available'}is-invalid{/if}" 
                                                       type="checkbox" id="available" name="available" value="1"
                                                       {if !isset($old_data.available) || (isset($old_data.available) && $old_data.available == 1)}checked{/if}>
                                                <label class="form-check-label" for="available">Disponible</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab: Atributos Especiales -->
                    <div class="tab-pane fade" id="attributes" role="tabpanel">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Los campos especiales se cargar√°n autom√°ticamente cuando selecciones un tipo de producto.
                        </div>
                        <div id="specialFieldsContainer">
                            <p class="text-muted">Selecciona un tipo de producto en la pesta√±a "Informaci√≥n General" para ver los campos especializados.</p>
                        </div>
                    </div>
                    
                    <!-- Tab: SEO y Meta Tags -->
                    <div class="tab-pane fade" id="seo" role="tabpanel">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Configuraci√≥n de metadatos para optimizaci√≥n SEO y redes sociales.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3"><i class="bi bi-globe me-2"></i>Meta Tags B√°sicos</h5>
                                
                                <div class="mb-3">
                                    <label for="title" class="form-label">T√≠tulo de P√°gina</label>
                                    <input type="text" class="form-control {if isset($error_field) && $error_field == 'title'}is-invalid{/if}" 
                                           name="title" id="title" 
                                           maxlength="70" value="{if isset($old_data.title)}{$old_data.title}{/if}"
                                           placeholder="T√≠tulo optimizado para SEO">
                                    {if isset($error_field) && $error_field == 'title'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">
                                        <span id="titleCounter">0</span>/70 caracteres. Ideal: 50-60 caracteres.
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="meta_title" class="form-label">Meta T√≠tulo</label>
                                    <input type="text" class="form-control {if isset($error_field) && $error_field == 'meta_title'}is-invalid{/if}" 
                                           name="meta_title" id="meta_title" 
                                           maxlength="70" value="{if isset($old_data.meta_title)}{$old_data.meta_title}{/if}"
                                           placeholder="Meta t√≠tulo para buscadores">
                                    {if isset($error_field) && $error_field == 'meta_title'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">
                                        <span id="metaTitleCounter">0</span>/70 caracteres. Aparece en los resultados de b√∫squeda.
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="meta_description" class="form-label">Meta Descripci√≥n</label>
                                    <textarea class="form-control {if isset($error_field) && $error_field == 'meta_description'}is-invalid{/if}" 
                                              name="meta_description" id="meta_description" 
                                              rows="3" maxlength="160"
                                              placeholder="Descripci√≥n para resultados de b√∫squeda">{if isset($old_data.meta_description)}{$old_data.meta_description}{/if}</textarea>
                                    {if isset($error_field) && $error_field == 'meta_description'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">
                                        <span id="metaDescCounter">0</span>/160 caracteres. Descripci√≥n en los resultados de Google.
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="meta_keywords" class="form-label">Palabras Clave</label>
                                    <input type="text" class="form-control {if isset($error_field) && $error_field == 'meta_keywords'}is-invalid{/if}" 
                                           name="meta_keywords" id="meta_keywords" 
                                           maxlength="255" value="{if isset($old_data.meta_keywords)}{$old_data.meta_keywords}{/if}"
                                           placeholder="keyword1, keyword2, keyword3">
                                    {if isset($error_field) && $error_field == 'meta_keywords'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">Separadas por comas. M√°ximo 255 caracteres.</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3"><i class="bi bi-share me-2"></i>Open Graph (Redes Sociales)</h5>
                                
                                <div class="mb-3">
                                    <label for="og_title" class="form-label">OG Title</label>
                                    <input type="text" class="form-control {if isset($error_field) && $error_field == 'og_title'}is-invalid{/if}" 
                                           name="og_title" id="og_title" 
                                           maxlength="70" value="{if isset($old_data.og_title)}{$old_data.og_title}{/if}"
                                           placeholder="T√≠tulo para compartir en redes">
                                    {if isset($error_field) && $error_field == 'og_title'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">
                                        <span id="ogTitleCounter">0</span>/70 caracteres. T√≠tulo para Facebook, Twitter, etc.
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="og_description" class="form-label">OG Description</label>
                                    <textarea class="form-control {if isset($error_field) && $error_field == 'og_description'}is-invalid{/if}" 
                                              name="og_description" id="og_description" 
                                              rows="3" maxlength="160"
                                              placeholder="Descripci√≥n para compartir en redes">{if isset($old_data.og_description)}{$old_data.og_description}{/if}</textarea>
                                    {if isset($error_field) && $error_field == 'og_description'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">
                                        <span id="ogDescCounter">0</span>/160 caracteres. Descripci√≥n para redes sociales.
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="og_image" class="form-label">OG Image URL</label>
                                    <input type="url" class="form-control {if isset($error_field) && $error_field == 'og_image'}is-invalid{/if}" 
                                           name="og_image" id="og_image" 
                                           maxlength="255" value="{if isset($old_data.og_image)}{$old_data.og_image}{/if}"
                                           placeholder="https://ejemplo.com/imagen.jpg">
                                    {if isset($error_field) && $error_field == 'og_image'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">URL de la imagen que se mostrar√° al compartir. Tama√±o recomendado: 1200√ó630px.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="og_type" class="form-label">OG Type</label>
                                    <select class="form-control {if isset($error_field) && $error_field == 'og_type'}is-invalid{/if}" 
                                            name="og_type" id="og_type">
                                        <option value="">Selecciona un tipo</option>
                                        <option value="product" {if isset($old_data.og_type) && $old_data.og_type == 'product'}selected{/if}>Producto</option>
                                        <option value="article" {if isset($old_data.og_type) && $old_data.og_type == 'article'}selected{/if}>Art√≠culo</option>
                                        <option value="website" {if isset($old_data.og_type) && $old_data.og_type == 'website'}selected{/if}>Sitio Web</option>
                                    </select>
                                    {if isset($error_field) && $error_field == 'og_type'}
                                        <div class="invalid-feedback">{$error}</div>
                                    {/if}
                                    <div class="form-text">Tipo de contenido para Open Graph.</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-lightbulb me-2"></i>
                            <strong>Consejo:</strong> Si dejas vac√≠os los campos de SEO, se generar√°n autom√°ticamente a partir de la informaci√≥n b√°sica del producto.
                        </div>
                    </div>
                </div>
                
                <!-- Botones de acci√≥n -->
                <div class="d-flex gap-2 mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Crear Producto
                    </button>
                    <a href="{:url('product_index')}" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-2"></i>Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de aviso -->
    <div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title"><i class="bi bi-exclamation-circle me-2"></i>Aviso</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <p id="alertMessage">Mensaje de aviso...</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
          </div>
        </div>
      </div>
    </div>

{/block}

{block name="scripts"}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Obtener elementos del modal de aviso
    const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
    const alertMessage = document.getElementById('alertMessage');

    // Funci√≥n para mostrar mensaje en el modal
    function showAlert(message) {
        alertMessage.innerHTML = message.replace(/\n/g, '<br>');
        alertModal.show();
    }

    // Contadores de caracteres para campos SEO
    const counters = {
        'title': 'titleCounter',
        'meta_title': 'metaTitleCounter',
        'meta_description': 'metaDescCounter',
        'og_title': 'ogTitleCounter',
        'og_description': 'ogDescCounter'
    };

    // Inicializar contadores
    Object.keys(counters).forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const counter = document.getElementById(counters[fieldId]);
        
        if (field && counter) {
            // Actualizar contador inicial
            counter.textContent = field.value.length;
            
            // Actualizar en tiempo real
            field.addEventListener('input', function() {
                counter.textContent = this.value.length;
                
                // Cambiar color si se excede el l√≠mite recomendado
                if (this.value.length > 60 && fieldId.includes('title')) {
                    counter.classList.add('text-warning');
                } else {
                    counter.classList.remove('text-warning');
                }
            });
        }
    });

    // Gesti√≥n de campos especiales
    const productTypeSelect = document.getElementById('product_type_id');
    const specialFieldsContainer = document.getElementById('specialFieldsContainer');
    
    if (productTypeSelect && specialFieldsContainer) {
        productTypeSelect.addEventListener('change', function() {
            const productTypeId = this.value;
            
            if (productTypeId) {
                specialFieldsContainer.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p>Cargando campos especializados...</p></div>';
                
                fetch('{:url("product_get_special_fields")}?product_type_id=' + productTypeId)
                    .then(response => {
                        if (!response.ok) throw new Error('Error en la respuesta del servidor');
                        return response.text();
                    })
                    .then(data => {
                        specialFieldsContainer.innerHTML = data;
                    })
                    .catch(error => {
                        console.error('Error al cargar campos:', error);
                        specialFieldsContainer.innerHTML = '<p class="text-danger">Error al cargar campos especializados</p>';
                    });
            } else {
                specialFieldsContainer.innerHTML = '<p class="text-muted">Selecciona un tipo de producto para ver sus campos especializados</p>';
            }
        });
    }
    
    // Auto-generar slug desde el nombre
    const nameInput = document.getElementById('name');
    const slugInput = document.getElementById('slug');
    
    if (nameInput && slugInput) {
        nameInput.addEventListener('blur', function() {
            if (!slugInput.value.trim()) {
                const slug = this.value
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '');
                slugInput.value = slug;
            }
        });
    }
    
    // Auto-generar Amazon link desde el ASIN
    const asinInput = document.getElementById('asin');
    const amazonlinkInput = document.getElementById('amazonlink');
    
    if (asinInput && amazonlinkInput) {
        asinInput.addEventListener('blur', function() {
            if (this.value.trim() && !amazonlinkInput.value.trim()) {
                const asin = this.value.trim();
                const amazonLink = `https://amazon.es/dp/${asin}?tag=leadtech21`;
                amazonlinkInput.value = amazonLink;
            }
        });
        
        // Tambi√©n generar si el ASIN cambia y el link est√° vac√≠o
        asinInput.addEventListener('input', function() {
            if (this.value.trim() && !amazonlinkInput.value.trim()) {
                const asin = this.value.trim();
                const amazonLink = `https://amazon.es/dp/${asin}?tag=leadtech21`;
                amazonlinkInput.value = amazonLink;
            }
        });
    }
    
    // Previsualizaci√≥n de imagen
    const picInput = document.getElementById('pic');
    
    function createPreview(input, previewId) {
        const previewContainer = document.getElementById(previewId);
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewContainer.innerHTML = `
                    <div class="mt-2">
                        <img src="${e.target.result}" class="img-thumbnail" style="max-height: 200px; max-width: 100%;">
                        <button type="button" class="btn btn-sm btn-danger mt-2" onclick="document.getElementById('${previewId}').innerHTML=''">
                            <i class="bi bi-x-circle"></i> Eliminar previsualizaci√≥n
                        </button>
                    </div>
                `;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    if (picInput) {
        picInput.addEventListener('change', function() {
            createPreview(this, 'picPreview');
        });
    }
    
    // Validaci√≥n del formulario
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        let isValid = true;
        const tabsWithErrors = new Set();
        
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');
                
                // Encontrar en qu√© tab est√° este campo
                const tabPane = field.closest('.tab-pane');
                if (tabPane) {
                    const tabId = tabPane.id;
                    tabsWithErrors.add(tabId);
                }
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            
            // Activar el primer tab con errores
            if (tabsWithErrors.size > 0) {
                const firstTabId = Array.from(tabsWithErrors)[0];
                const tabLink = document.querySelector(`[href="#${firstTabId}"]`);
                if (tabLink) {
                    const tab = new bootstrap.Tab(tabLink);
                    tab.show();
                }
            }
            
            // Mensaje mejorado que indica d√≥nde est√°n los errores
            let message = 'Por favor, complete todos los campos obligatorios marcados con *.';
            
            if (tabsWithErrors.size > 0) {
                const tabNames = {
                    'general': 'Informaci√≥n General',
                    'attributes': 'Atributos Especiales', 
                    'seo': 'SEO y Meta Tags'
                };
                
                const errorTabs = Array.from(tabsWithErrors).map(tabId => tabNames[tabId] || tabId);
                message += `\n\nCampos faltantes en: ${errorTabs.join(', ')}`;
            }
            
            showAlert(message);
            
            // Scroll al primer error
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
    });
});
</script>
{/block}