{extend name="admin/layout" /}

{block name="content"}
<div class="card">
    <div class="card-header">
        <h3>Nuevo producto</h3>
    </div>
    <div class="card-body">
        <form method="post" action="{:url('product_save')}" enctype="multipart/form-data">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" data-toggle="tab" href="#general" role="tab">General</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" data-toggle="tab" href="#attributes" role="tab">Atributos especiales</a>
                </li>
            </ul>

            <div class="tab-content pt-3">
                <!-- General -->
                <div class="tab-pane fade show active" id="general" role="tabpanel">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label>Slug</label>
                        <input type="text" name="slug" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label>SKU</label>
                        <input type="text" name="sku" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label>ASIN</label>
                        <input type="text" name="asin" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label>Fabricante</label>
                        <input type="text" name="manufacturer" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label>C√≥digo de producto</label>
                        <input type="text" name="productcode" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Enlace de Amazon</label>
                        <input type="url" name="amazonlink" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Precio</label>
                        <input type="number" step="0.01" name="price" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <textarea name="description" class="form-control"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Stock</label>
                        <input type="number" name="stock" class="form-control" value="0">
                    </div>

                    <div class="form-group">
                        <label>Likes</label>
                        <input type="number" name="like" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Visible</label>
                        <select name="visible" class="form-control">
                            <option value="0">No</option>
                            <option value="1">S√≠</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Disponible</label>
                        <select name="available" class="form-control">
                            <option value="0">No</option>
                            <option value="1">S√≠</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Imagen principal</label>
                        <input type="file" name="pic" class="form-control-file">
                    </div>

                    <div class="form-group">
                        <label>Marca</label>
                        <select name="brand_id" class="form-control" required>
                            <option value="">Selecciona una marca</option>
                            {volist name="brands" id="brand"}
                                <option value="{$brand.id}">{$brand.brand_en}</option>
                            {/volist}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <select name="category_id" class="form-control" required>
                            <option value="">Selecciona una categor√≠a</option>
                            {volist name="categories" id="category"}
                                <option value="{$category.id}">{$category.txt_short}</option>
                            {/volist}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Tipo de producto</label>
                        <select name="product_type_id" class="form-control" required>
                            <option value="">Selecciona un tipo</option>
                            {volist name="productTypes" id="type"}
                                <option value="{$type.id}">{$type.txt_short}</option>
                            {/volist}
                        </select>
                    </div>
                </div>

                <!-- Atributos especiales -->
                <div class="tab-pane fade" id="attributes" role="tabpanel">
                    <p class="text-muted">Aqu√≠ se mostrar√°n los campos especiales seg√∫n el tipo de producto seleccionado.</p>
                </div>
            </div>

            <div class="form-group mt-3">
                <button type="submit" class="btn btn-primary">Guardar</button>
                <a href="{:url('product_index')}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM cargado - Iniciando gesti√≥n de campos especiales');
    
    const productTypeSelect = document.querySelector('select[name="product_type_id"]');
    const attributesTab = document.getElementById('attributes');
    
    if (!productTypeSelect || !attributesTab) {
        console.error('‚ùå Elementos no encontrados');
        return;
    }
    
    productTypeSelect.addEventListener('change', function() {
        const productTypeId = this.value;
        console.log('üéØ Tipo de producto seleccionado:', productTypeId);
        
        if (productTypeId) {
            // Mostrar loading
            attributesTab.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p>Cargando campos especializados...</p></div>';
            
            // Usar la URL correcta con el nombre de la ruta
            fetch('/admin/product/get-special-fields?product_type_id=' + productTypeId)
                .then(response => {
                    if (!response.ok) throw new Error('Error en la respuesta del servidor');
                    return response.text();
                })
                .then(data => {
                    attributesTab.innerHTML = data;
                    console.log('‚úÖ Campos especializados cargados correctamente');
                })
                .catch(error => {
                    console.error('‚ùå Error al cargar campos:', error);
                    attributesTab.innerHTML = '<p class="text-danger">Error al cargar campos especializados</p>';
                });
        } else {
            attributesTab.innerHTML = '<p class="text-muted">Selecciona un tipo de producto para ver sus campos especializados</p>';
        }
    });
    
    console.log('‚úÖ Event listener configurado correctamente');
});
</script>

{/block}


