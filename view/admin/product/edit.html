{extend name="admin/layout" /}

{block name="content"}

{if isset($error)}
    <div class="alert alert-danger">{$error}</div>
{/if}

<div class="card">
    <div class="card-header">
        <h3>Editar producto</h3>
    </div>

    <form method="post" action="{:url('product_update', ['id' => $product.id])}" enctype="multipart/form-data">

        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <button class="nav-link active" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home" aria-selected="true">Principal</button>
                <button class="nav-link" id="nav-profile-tab" data-bs-toggle="tab" data-bs-target="#nav-profile" type="button" role="tab" aria-controls="nav-profile" aria-selected="false">Especial</button>
            </div>
        </nav>
        
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">

                <!-- Sección de imagen -->
                <div class="form-group">
                    <label>Imagen actual</label>
                    {if $product.pic}
                        <div class="mb-2">
                            <img src="/static/img/product/thumb_{$product.pic}" alt="{$product.name}" width="150" height="150" style="object-fit: cover; border: 1px solid #ddd; padding: 5px;">
                            <div class="mt-1">
                                <small class="text-muted">{$product.pic}</small>
                            </div>
                        </div>
                    {else /}
                        <p class="text-muted">No hay imagen subida</p>
                    {/if}
                </div>

                <div class="form-group">
                    <label>Nueva imagen (reemplazar actual)</label>
                    <input type="file" name="pic" class="form-control" accept="image/jpeg,image/png,image/gif,image/webp">
                    <small class="form-text text-muted">
                        Formatos: JPG, PNG, GIF, WEBP. Máx. 5MB. Debe ser cuadrada y mínimo 1500x1500px.
                    </small>
                </div>

                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" name="name" class="form-control" value="{$product.name}" required>
                </div>

                <div class="form-group">
                    <label>Slug</label>
                    <input type="text" name="slug" class="form-control" value="{$product.slug}" required>
                </div>

                <div class="form-group">
                    <label>SKU</label>
                    <input type="text" name="sku" class="form-control" value="{$product.sku}" required>
                </div>

                <div class="form-group">
                    <label>ASIN</label>
                    <input type="text" name="asin" class="form-control" value="{$product.asin}" required>
                </div>

                <div class="form-group">
                    <label>Fabricante</label>
                    <input type="text" name="manufacturer" class="form-control" value="{$product.manufacturer}" required>
                </div>

                <div class="form-group">
                    <label>Código de producto</label>
                    <input type="text" name="productcode" class="form-control" value="{$product.productcode}">
                </div>

                <div class="form-group">
                    <label>Enlace de Amazon</label>
                    <input type="url" name="amazonlink" class="form-control" value="{$product.amazonlink}">
                </div>

                <div class="form-group">
                    <label>Precio</label>
                    <input type="number" step="0.01" name="price" class="form-control" value="{$product.price}">
                </div>

                <div class="form-group">
                    <label>Descripción</label>
                    <textarea name="description" class="form-control">{$product.description}</textarea>
                </div>

                <div class="form-group">
                    <label>Stock</label>
                    <input type="number" name="stock" class="form-control" value="{$product.stock}">
                </div>

                <div class="form-group">
                    <label>Likes</label>
                    <input type="number" name="like" class="form-control" value="{$product.like}">
                </div>

                <div class="form-group">
                    <label>Visible</label>
                    <select name="visible" class="form-control">
                        <option value="0" {eq name="$product.visible" value="0"}selected{/eq}>No</option>
                        <option value="1" {eq name="$product.visible" value="1"}selected{/eq}>Sí</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Disponible</label>
                    <select name="available" class="form-control">
                        <option value="0" {eq name="$product.available" value="0"}selected{/eq}>No</option>
                        <option value="1" {eq name="$product.available" value="1"}selected{/eq}>Sí</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Marca</label>
                    <select name="brand_id" class="form-control" required>
                        <option value="">Selecciona una marca</option>
                        {volist name="brands" id="brand"}
                            <option value="{$brand.id}" {eq name="$product.brand_id" value="$brand.id"}selected{/eq}>{$brand.brand_en}</option>
                        {/volist}
                    </select>
                </div>

                <div class="form-group">
                    <label>Categoría</label>
                    <select name="category_id" class="form-control" required>
                        <option value="">Selecciona una categoría</option>
                        {volist name="categories" id="category"}
                            <option value="{$category.id}" {eq name="$product.category_id" value="$category.id"}selected{/eq}>{$category.txt_short}</option>
                        {/volist}
                    </select>
                </div>

                <div class="form-group">
                    <label>Tipo de producto</label>
                    <select name="product_type_id" class="form-control" required>
                        <option value="">Selecciona un tipo</option>
                        {volist name="productTypes" id="type"}
                            <option value="{$type.id}" {eq name="$product.product_type_id" value="$type.id"}selected{/eq}>{$type.name}</option>
                        {/volist}
                    </select>
                </div>

            </div>
            
            <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab">
                
                {if !empty($specialFields)}
                    <div class="alert alert-info">Edita los atributos especiales del producto:</div>
                    {volist name="specialFields" id="field"}
                        <div class="form-group">
                            <label>{$field.name}</label>
                            {switch field.data_type}
                                {case value="boolean"}
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="special[{$field.id}]" value="1"
                                            {if isset($specialValues[$field.id]) && $specialValues[$field.id] == 1}checked{/if}>
                                        <label class="form-check-label">Sí</label>
                                    </div>
                                {/case}
                                {case value="integer"}
                                    <input type="number" class="form-control" name="special[{$field.id}]" value="{$specialValues[$field.id]|default=''}">
                                {/case}
                                {case value="float"}
                                    <input type="text" class="form-control" name="special[{$field.id}]" value="{$specialValues[$field.id]|default=''}">
                                {/case}
                                {default /}
                                    <input type="text" class="form-control" name="special[{$field.id}]" value="{$specialValues[$field.id]|default=''}">
                            {/switch}
                            {if $field.unit}
                                <small class="form-text text-muted">Unidad: {$field.unit}</small>
                            {/if}
                        </div>
                    {/volist}
                {else /}
                    <p class="text-muted">Este producto no tiene atributos especiales definidos.</p>
                {/if}

            </div>
        </div>

        <div class="form-group mt-3">
            <button type="submit" class="btn btn-primary">Actualizar</button>
            <a href="{:url('product_index')}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

{/block}